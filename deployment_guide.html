<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>deployment_guide</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<figure>
<img src="./assets/header.png" alt="scw_bg" />
<figcaption aria-hidden="true">scw_bg</figcaption>
</figure>
<figure>
<img src="./assets/opennebula.svg"
alt="opennebula_cloud_logo_white_bg" />
<figcaption
aria-hidden="true">opennebula_cloud_logo_white_bg</figcaption>
</figure>
<h1 id="deployment-guide">Deployment Guide</h1>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#1-scaleway-hosted-cloud-overview">1. Scaleway Hosted Cloud
Overview</a></li>
<li><a href="#2-requirements">2. Requirements</a></li>
<li><a href="#3-repository-setup">3. Repository Setup</a></li>
<li><a href="#4-secrets-and-environment-variables">4. Secrets and
Environment Variables</a></li>
<li><a href="#5-infrastructure-provisioning-opentofu-modules">5.
Infrastructure Provisioning (OpenTofu Modules)</a></li>
<li><a href="#6-inventory-and-parameter-management">6. Inventory and
Parameter Management</a></li>
<li><a href="#7-networking-configuration">7. Networking
Configuration</a></li>
<li><a href="#8-opennebula-deployment-workflow">8. OpenNebula Deployment
Workflow</a></li>
<li><a href="#9-validation-suite">9. Validation Suite</a></li>
<li><a href="#10-troubleshooting--known-issues">10. Troubleshooting
&amp; Known Issues</a></li>
<li><a href="#11-cicd-roadmap">11. CI/CD Roadmap</a></li>
<li><a href="#12-extending-the-cloud">12. Extending the Cloud</a></li>
</ul>
<h2 id="scaleway-hosted-cloud-overview">1. Scaleway Hosted Cloud
Overview</h2>
<p>This repository delivers the Terraform, Ansible, and driver
customizations required to build an OpenNebula Hosted Cloud on
<strong>Scaleway Elastic Metal</strong>. It extends the upstream <a
href="https://github.com/OpenNebula/one-deploy"><code>one-deploy</code></a>
and <a
href="https://github.com/OpenNebula/one-deploy-validation"><code>one-deploy-validation</code></a>
projects via git submodules and adds Scaleway-specific infrastructure
modules, inventories, and Flexible IP (FIP) drivers.</p>
<h3 id="objectives">Objectives</h3>
<p>Deploy a full-featured IaaS environment on bare-metal servers with
deterministic networking, managed inventories, and reusable automation
so that OpenNebula can be repeatedly installed, validated, and extended
on Scaleway.</p>
<h3 id="core-components">Core Components</h3>
<p><strong>OpenNebula Front-end (with KVM):</strong></p>
<ul>
<li>Manages the entire lifecycle of virtual machines (VMs) and doubles
as a compute node.</li>
<li>Provides the OpenNebula CLI/API and Sunstone UI for operators.</li>
</ul>
<p><strong>Hypervisor Nodes:</strong></p>
<ul>
<li>EM-A610R-NVMe instances running KVM and attached to the same private
network as the frontend.</li>
<li>Can receive public connectivity via Flexible IPs (FIPs) or a Public
Gateway.</li>
</ul>
<p><code>roles/one-driver</code> ships a custom VNM bridge hook that
attaches and detaches FIPs through the Scaleway APIs. Commits
<code>967216f</code>, <code>4399aed</code>, and <code>a165376</code>
added multi-NIC support and improved cleanup and logging under
<code>/var/log/vnm</code>.</p>
<h3 id="storage">Storage</h3>
<ul>
<li>2× NVMe 960 GB drives per node provide high IOPS local storage for
VM images and context disks.</li>
</ul>
<h3 id="networking">Networking</h3>
<ul>
<li>Private connectivity is delivered through a VPC/VLAN mesh created by
the Terraform modules under <code>scw/</code>.</li>
<li>Public access can attach directly to instances in the MVP phase or
via a Public Gateway for higher-scale deployments.</li>
<li>The default netplan layout creates <code>br0</code> for public/FIP
traffic, <code>brvmtovm</code> for host-to-host VXLAN, and VLAN-tagged
subinterfaces for tenant networks.</li>
</ul>
<figure>
<img src="./assets/schemascw.png" alt="Networking Diagram" />
<figcaption aria-hidden="true">Networking Diagram</figcaption>
</figure>
<h3 id="high-level-diagram">High-Level Diagram</h3>
<figure>
<img src="./assets/schemascw-opennebula.png" alt="High-Level Diagram" />
<figcaption aria-hidden="true">High-Level Diagram</figcaption>
</figure>
<h3 id="hardware-specification">Hardware Specification</h3>
<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 24%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 11%" />
<col style="width: 8%" />
<col style="width: 11%" />
<col style="width: 18%" />
</colgroup>
<thead>
<tr class="header">
<th>Role</th>
<th>Instance Type</th>
<th>CPU</th>
<th>RAM</th>
<th>Disks</th>
<th>KVM</th>
<th>Count</th>
<th>Bandwidth</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Front-end + KVM</td>
<td>EM-A610R-NVMe</td>
<td>AMD Ryzen PRO 3600 (6C / 12T)</td>
<td>16 GB</td>
<td>2× NVMe 960 GB</td>
<td>Yes</td>
<td>1</td>
<td>Up to 1 Gbps</td>
</tr>
<tr class="even">
<td>Hypervisor(s)</td>
<td>EM-A610R-NVMe</td>
<td>AMD Ryzen PRO 3600 (6C / 12T)</td>
<td>16 GB</td>
<td>2× NVMe 960 GB</td>
<td>Yes</td>
<td>1..N</td>
<td>Up to 1 Gbps</td>
</tr>
</tbody>
</table>
<h3 id="provisioning-strategies">Provisioning Strategies</h3>
<p><strong>Prerequisites</strong></p>
<ul>
<li>Ubuntu 22.04 or 24.04 with Netplan ≥ 0.105 on provisioned
nodes.</li>
<li>Password-less SSH from the frontend to hypervisors.</li>
<li>Ability to sudo to root on all nodes.</li>
<li>A pool of free IP addresses on the management network.</li>
</ul>
<p><strong>Capabilities</strong></p>
<ul>
<li>Utilization of OneDeploy roles/tags and the OneHook driver.</li>
<li>Automated inventories rendered from Terraform outputs.</li>
<li>Re-runnable Ansible plays to keep hooks and packages up to
date.</li>
</ul>
<h2 id="requirements">2. Requirements</h2>
<table>
<colgroup>
<col style="width: 39%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="header">
<th>Component</th>
<th>Version / Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>OpenTofu</td>
<td>≥ 1.5.0 (used by the <code>scw/*</code> modules)</td>
</tr>
<tr class="even">
<td>Python / pip</td>
<td>Needed for <a href="https://hatch.pypa.io">hatch</a> and Ansible
tooling</td>
</tr>
<tr class="odd">
<td>Hatch</td>
<td>Manages the <code>scaleway-default</code> execution environment</td>
</tr>
<tr class="even">
<td>Ansible</td>
<td>Driven via the Makefile targets</td>
</tr>
<tr class="odd">
<td>Scaleway Credentials</td>
<td>API access key, secret key, organization/project IDs</td>
</tr>
</tbody>
</table>
<p>Manual prerequisites (before automation):</p>
<ul>
<li>Create a Scaleway project (Console: Account &gt; Projects) and an
API key with <code>ElasticMetalFullAccess</code> +
<code>IPAMFullAccess</code> (Console: IAM &gt; API Keys). No bare-metal
server needs to be pre-created—the Terraform modules provision the
Elastic Metal servers and also create the Flexible IP IAM
application/token automatically in module <code>005</code>.</li>
</ul>
<p>Install the local tooling:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install hatch</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> submodule-requirements     <span class="co"># installs Ansible collection deps</span></span></code></pre></div>
<h2 id="repository-setup">3. Repository Setup</h2>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/OpenNebula/hosted-cloud-scaleway.git</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> hosted-cloud-scaleway</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> submodule update <span class="at">--init</span> <span class="at">--remote</span> <span class="at">--merge</span></span></code></pre></div>
<p>The Makefile shortcuts (<code>deployment</code>,
<code>validation</code>, <code>specifics</code>,
<code>submodule-requirements</code>) proxy into the submodules with the
Scaleway inventories pre-selected. Run commands from the repo root so
relative paths (for keys, inventories, etc.) resolve correctly.</p>
<h2 id="secrets-and-environment-variables">4. Secrets and Environment
Variables</h2>
<ol type="1">
<li><p>Copy the template and populate credentials:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> .secret.skel .secret</span></code></pre></div></li>
<li><p>Edit <code>.secret</code> with the Terraform
(<code>TF_VAR_*</code>) values, Scaleway credentials
(<code>SCW_*</code>), AWS-compatible aliases (used by OpenTofu
backends), and OpenNebula password. Create an
<strong>Admin-level</strong> API key in the Scaleway Console at
<strong>IAM &gt; API Keys</strong> (covers the needed ElasticMetal +
IPAM permissions). The Flexible IP IAM application/token is created
automatically by module <code>005</code> and injected into the generated
inventory; you do <strong>not</strong> need to pre-create or store this
token. <code>SCW_DEFAULT_PROJECT_ID</code> is optional (not used by the
modules).</p></li>
<li><p>Source the file before running any <code>tofu</code> or
<code>make</code> commands:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> .secret</span></code></pre></div></li>
</ol>
<p>Key inputs:</p>
<ul>
<li><code>TF_VAR_customer_name</code>, <code>TF_VAR_project_name</code>,
<code>TF_VAR_project_fullname</code> for resource naming.</li>
<li><code>TF_VAR_state_infrastructure_information</code> — object with
<code>scw_infrastructure_project_name</code> (used to name the dedicated
state project); <code>TF_VAR_tfstate</code> — bucket prefix for remote
state. These two must be set or <code>tofu plan</code> will prompt for
them.</li>
<li><code>TF_VAR_private_subnet</code>,
<code>TF_VAR_vmtovm_subnet</code>, <code>TF_VAR_worker_count</code>, and
netplan-related CIDRs consumed by <code>scw/003</code> and
<code>scw/004</code>.</li>
<li><code>SCW_ACCESS_KEY</code>, <code>SCW_SECRET_KEY</code>,
<code>SCW_DEFAULT_ORGANIZATION_ID</code>,
<code>SCW_DEFAULT_REGION</code>, <code>SCW_DEFAULT_ZONE</code>.
<code>SCW_DEFAULT_PROJECT_ID</code> is optional (not used by the
modules).</li>
<li><code>TF_VAR_scw_secret_key</code> (often set to
<code>$SCW_SECRET_KEY</code>) and AWS-compatible aliases
(<code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code>) for
the backend.</li>
<li><code>scw_flexible_ip_*</code> defaults referenced by
<code>roles/one-driver/defaults/main.yaml</code> (populated by module
<code>005</code>).</li>
</ul>
<blockquote>
<p><code>.secret</code> is ignored by git; never commit credential
material.</p>
</blockquote>
<h2 id="infrastructure-provisioning-opentofu-modules">5. Infrastructure
Provisioning (OpenTofu Modules)</h2>
<p>Modules live under <code>scw/</code> and must be executed
sequentially with OpenTofu (or Terraform). Each directory contains its
own state and variables.</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 33%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr class="header">
<th>Order</th>
<th>Module</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>001</td>
<td><code>terraform_state_management</code></td>
<td>Bootstrap state bucket/project metadata</td>
</tr>
<tr class="even">
<td>002</td>
<td><code>vpc</code></td>
<td>Create the VPC, VLANs, and subnet layout</td>
</tr>
<tr class="odd">
<td>003</td>
<td><code>opennebula_instances</code></td>
<td>Provision the frontend and KVM nodes + cloud-init assets</td>
</tr>
<tr class="even">
<td>004</td>
<td><code>opennebula_instances_net</code></td>
<td>Configure netplan, VLAN tags, and Ethernet aliases</td>
</tr>
<tr class="odd">
<td>005</td>
<td><code>opennebula_inventories</code></td>
<td>Render <code>inventory/scaleway.yml</code> and helper artifacts</td>
</tr>
</tbody>
</table>
<p>Run each module in order after <code>source .secret</code> (keep them
separate to ease debugging):</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> scw/001.terraform_state_management <span class="kw">&amp;&amp;</span> <span class="ex">tofu</span> init <span class="kw">&amp;&amp;</span> <span class="ex">tofu</span> plan <span class="at">-input</span><span class="op">=</span>false <span class="kw">&amp;&amp;</span> <span class="ex">tofu</span> apply <span class="kw">&amp;&amp;</span> <span class="bu">cd</span> ../..</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> scw/002.vpc                      <span class="kw">&amp;&amp;</span> <span class="ex">tofu</span> init <span class="kw">&amp;&amp;</span> <span class="ex">tofu</span> plan <span class="at">-input</span><span class="op">=</span>false <span class="kw">&amp;&amp;</span> <span class="ex">tofu</span> apply <span class="kw">&amp;&amp;</span> <span class="bu">cd</span> ../..</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> scw/003.opennebula_instances     <span class="kw">&amp;&amp;</span> <span class="ex">tofu</span> init <span class="kw">&amp;&amp;</span> <span class="ex">tofu</span> plan <span class="at">-input</span><span class="op">=</span>false <span class="kw">&amp;&amp;</span> <span class="ex">tofu</span> apply <span class="kw">&amp;&amp;</span> <span class="bu">cd</span> ../..</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> scw/004.opennebula_instances_net <span class="kw">&amp;&amp;</span> <span class="ex">tofu</span> init <span class="kw">&amp;&amp;</span> <span class="ex">tofu</span> plan <span class="at">-input</span><span class="op">=</span>false <span class="kw">&amp;&amp;</span> <span class="ex">tofu</span> apply <span class="kw">&amp;&amp;</span> <span class="bu">cd</span> ../..</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> scw/005.opennebula_inventories   <span class="kw">&amp;&amp;</span> <span class="ex">tofu</span> init <span class="kw">&amp;&amp;</span> <span class="ex">tofu</span> plan <span class="at">-input</span><span class="op">=</span>false <span class="kw">&amp;&amp;</span> <span class="ex">tofu</span> apply <span class="kw">&amp;&amp;</span> <span class="bu">cd</span> ../..</span></code></pre></div>
<p>Notes:</p>
<ul>
<li>If <code>tofu plan</code> prompts for
<code>state_infrastructure_information</code> or <code>tfstate</code>,
the environment variables
<code>TF_VAR_state_infrastructure_information</code> and
<code>TF_VAR_tfstate</code> were not exported (fill them in
<code>.secret</code> and re-source it). Using <code>-input=false</code>
surfaces the missing names immediately.</li>
<li>No bare-metal resources are required beforehand—the modules above
create the Elastic Metal servers, networking, inventories, and the
Flexible IP IAM application/token for you. The generated token is
written into <code>inventory/scaleway.yml</code> as
<code>scw_flexible_ip_token</code>.</li>
</ul>
<p>Review <code>deployment_guide.md#7-networking-configuration</code>
for the expected netplan outputs and
<code>deployment_guide.md#6-inventory-and-parameter-management</code>
for generated files.</p>
<h2 id="inventory-and-parameter-management">6. Inventory and Parameter
Management</h2>
<p><code>inventory/scaleway.yml</code> is auto-generated by module
<code>005</code> but can be edited for PoCs. Supplementary values live
in <code>inventory/group_vars/all.yml</code>.</p>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 28%" />
<col style="width: 42%" />
</colgroup>
<thead>
<tr class="header">
<th>Description</th>
<th>Variable(s)</th>
<th>Files / Templates</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>SSH user and key path</td>
<td><code>ansible_user</code>,
<code>ansible_ssh_private_key_file</code></td>
<td><code>inventory/group_vars/all.yml</code></td>
</tr>
<tr class="even">
<td>Frontend + node metadata</td>
<td><code>frontend.hosts.*</code>, <code>node.hosts.*</code></td>
<td><code>inventory/scaleway.yml</code></td>
</tr>
<tr class="odd">
<td>Scaleway project/FIP identifiers</td>
<td><code>scw_project_id</code>, <code>scw_server_id</code>,
<code>scw_flexible_ip_token</code>,
<code>scw_flexible_ip_zone</code></td>
<td><code>inventory/scaleway.yml</code>,
<code>roles/one-driver/defaults/main.yaml</code></td>
</tr>
<tr class="even">
<td>OpenNebula credentials</td>
<td><code>one_pass</code>, <code>one_version</code></td>
<td><code>inventory/scaleway.yml</code>, <code>.secret</code></td>
</tr>
<tr class="odd">
<td>VNM templates</td>
<td><code>vn.pubridge.template.*</code>,
<code>vn.vxlan.template.*</code></td>
<td><code>inventory/scaleway.yml</code></td>
</tr>
<tr class="even">
<td>Validation knobs</td>
<td><code>validation.*</code></td>
<td><code>inventory/group_vars/all.yml</code></td>
</tr>
</tbody>
</table>
<p>Verify reachability once Terraform module <code>005</code>
completes:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ansible</span> <span class="at">-i</span> inventory/scaleway.yml all <span class="at">-m</span> ping <span class="at">-b</span></span></code></pre></div>
<p>Successful output resembles:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="er">fe</span> <span class="er">|</span> <span class="er">SUCCESS</span> <span class="er">=&gt;</span> <span class="fu">{</span> <span class="dt">&quot;changed&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span> <span class="dt">&quot;ping&quot;</span><span class="fu">:</span> <span class="st">&quot;pong&quot;</span> <span class="fu">}</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="er">host01</span> <span class="er">|</span> <span class="er">SUCCESS</span> <span class="er">=&gt;</span> <span class="fu">{</span> <span class="dt">&quot;changed&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span> <span class="dt">&quot;ping&quot;</span><span class="fu">:</span> <span class="st">&quot;pong&quot;</span> <span class="fu">}</span></span></code></pre></div>
<p>Ensure the SSH key path (default
<code>scw/003.opennebula_instances/opennebula.pem</code>) and hostnames
match what Terraform produced.</p>
<h2 id="networking-configuration">7. Networking Configuration</h2>
<ul>
<li>Cloud-init templates under
<code>scw/004.opennebula_instances_net/template/</code> apply
deterministic interfaces: <code>br0</code> (public/FIP),
<code>brvmtovm</code> (VXLAN), and VLAN-tagged subinterfaces for tenant
networks.</li>
<li><code>cloud_init_custom.tmpl</code> wires in OpenTofu outputs
(<code>base_public_ip</code>, <code>gateway</code>, VLAN assignments,
IPAM ranges) and assumes the bare-metal NIC is <code>enp5s0</code>.</li>
<li><code>roles/one-driver/templates/vnm/bridge/{pre,clean}.d</code>
hooks bring Flexible IPs online/offline and log to
<code>/var/log/vnm</code>.</li>
<li>After provisioning, run an Ansible ping and, if needed, re-apply
module <code>004</code> whenever netplan drift occurs.</li>
</ul>
<h2 id="opennebula-deployment-workflow">8. OpenNebula Deployment
Workflow</h2>
<ol type="1">
<li><p>Review the submodules (<code>submodule-one-deploy</code>,
<code>submodule-one-deploy-validation</code>) and local overrides
(<code>playbooks/scaleway.yml</code>,
<code>roles/one-driver</code>).</p></li>
<li><p>Deploy the base OpenNebula stack (frontend, hypervisors, shared
configs):</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> deployment</span></code></pre></div></li>
<li><p>Apply Scaleway-specific driver hooks and Flexible IP sync:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> specifics</span></code></pre></div></li>
<li><p>Run the validation suite:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> validation</span></code></pre></div></li>
</ol>
<p>All targets are idempotent; rerun them whenever roles or drivers
change. SSH into the frontend if manual debugging is required:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-i</span> scw/003.opennebula_instances/opennebula.pem ubuntu@<span class="op">&lt;</span>frontend-ip<span class="op">&gt;</span></span></code></pre></div>
<h2 id="validation-suite">9. Validation Suite</h2>
<p>Defaults in <code>inventory/group_vars/all.yml</code> enable:</p>
<ul>
<li>Core service health checks (<code>oned</code>, <code>gate</code>,
<code>flow</code>, <code>fireedge</code>).</li>
<li>Storage benchmark VM instantiation on <code>pub3</code>.</li>
<li>Network performance tests (iperf, ping) across hypervisors.</li>
<li>Connectivity matrix across hosts and <code>brvmtovm</code>.</li>
<li>Marketplace VM deploy &amp; smoke tests (Alpine Linux 3.21 template,
optional VNET creation).</li>
</ul>
<p>Disable individual tests by toggling the corresponding
<code>validation.run_*</code> flag. Reports land under
<code>/tmp/cloud_verification_report.html</code> and directories
documented in the inventory file.</p>
<h2 id="troubleshooting-known-issues">10. Troubleshooting &amp; Known
Issues</h2>
<ul>
<li><p><strong>Flexible IP attach/detach:</strong> Hooks under
<code>roles/one-driver/templates/vnm/bridge/{pre,clean}.d</code> keep
dedicated logs in <code>/var/log/vnm/scw-flexip-pre.log</code> (attach)
and <code>/var/log/vnm/scw-flexip-clean.log</code> (detach). Review
those files on the hypervisor whenever an attach/detach step hangs, then
rerun <code>make specifics</code> after script updates so hosts sync the
latest hooks.</p></li>
<li><p><strong>Ubuntu gateway for Flexible IPs:</strong> When a Flexible
IP resides outside the VM gateway netmask, Ubuntu may stall outbound
traffic. Persist the workaround with a dedicated netplan file (the bare
<code>ip route add</code> command disappears after reboot):</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /etc/netplan/99-flexip-route.yaml</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">network</span><span class="kw">:</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">renderer</span><span class="kw">:</span><span class="at"> networkd</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ethernets</span><span class="kw">:</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">eth0</span><span class="kw">:</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">routes</span><span class="kw">:</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">to</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;62.210.0.1/32&quot;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">via</span><span class="kw">:</span><span class="at"> </span><span class="fl">0.0.0.0</span></span></code></pre></div>
<p>Run <code>sudo netplan apply</code> to activate the route.
<code>ETH0_ROUTES</code> is affected by upstream bugs
(<code>OpenNebula/one-apps#284</code>,
<code>OpenNebula/one#7348</code>), so codifying the route via netplan is
the only reliable approach today.</p></li>
<li><p><strong>Host synchronization:</strong> The driver role runs
<code>onehost sync --force</code> for each host; investigate Ansible
output if sync fails.</p></li>
<li><p><strong>Networking drift:</strong> Re-apply module
<code>004.opennebula_instances_net</code> or netplan templates whenever
manual edits break VLAN alt-names or <code>brvmtovm</code>
routes.</p></li>
<li><p><strong>Credentials:</strong> Missing Flexible IP token
(<code>scw_flexible_ip_token</code>) or project ID causes the driver
role to abort via assertions.</p></li>
</ul>
<h2 id="cicd-roadmap">11. CI/CD Roadmap</h2>
<p><code>deployment_guide.md#5-infrastructure-provisioning-opentofu-modules</code>
and the sections above describe the manual workflow today. A future
GitHub Actions pipeline (WIP) will:</p>
<ol type="1">
<li>Validate sensitive inputs (tokens, CIDRs, host IPs).</li>
<li>Run <code>tofu init</code>/<code>plan</code> and block until
approved.</li>
<li>Require manual approval before <code>tofu apply</code>.</li>
<li>Configure Ansible, run <code>one-deploy-validation</code>,
<code>one-deploy</code>, and eventually <code>tofu destroy</code>.</li>
</ol>
<p>Sensitive inputs (Scaleway tokens, CIDRs, host IPs) should be stored
as encrypted pipeline variables. A reference Mermaid diagram:</p>
<pre class="mermaid"><code>graph TD;
    A[Input Validations] --&gt; B[terraform init];
    B --&gt; C[terraform plan];
    C --&gt; D[Manual terraform apply];
    D --&gt; E[Ansible Setup];
    D --&gt; F[Manual ansible playbook one-deploy-validation];
    D --&gt; G[Manual ansible one-deploy];
    G --&gt; H[Manual terraform plan destroy];
    F --&gt; H;
    E --&gt; H;
    H --&gt; I[Manual terraform destroy];</code></pre>
<h2 id="extending-the-cloud">12. Extending the Cloud</h2>
<p>To onboard additional hypervisors or iterate on the deployment:</p>
<ol type="1">
<li>Increase <code>TF_VAR_worker_count</code> (and other necessary
variables) and rerun modules <code>003</code> and <code>004</code>.</li>
<li>Regenerate inventories via module <code>005</code> and confirm SSH
access.</li>
<li>Run <code>make deployment</code> followed by
<code>make specifics</code> so hooks and metadata land on the new
hosts.</li>
<li>Re-run <code>make validation</code> to ensure the expanded capacity
integrates cleanly.</li>
</ol>
<p>For deeper background, architecture diagrams, and screenshots, keep
this guide close while executing the workflow end-to-end.</p>
</body>
</html>
