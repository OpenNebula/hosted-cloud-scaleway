#!/usr/bin/env bash
# Purpose: Attach a Scaleway Flexible IP to the target server prior to OpenNebula bridge setup.
# Expected input: OpenNebula-provided environment variables (VMID, NIC_ID, etc.) and base64 VM template via stdin.
# Expected output: No stdout on success; logs attachment workflow to /var/log/vnm/scw-flexip-pre.log.
set -euo pipefail

LOG_TAG="scw-flexip-pre[$$]"
ZONE="{{ one_driver_zone }}"
TOKEN_FILE="{{ one_driver_token_path }}"
API_ENDPOINT="{{ one_driver_fip_api_endpoint }}"
LOG_DIR="/var/log/vnm"
LOG_FILE="${LOG_DIR}/scw-flexip-pre.log"

log() {
  local msg="$*"
  local timestamp
  timestamp="$(date -u '+%Y-%m-%dT%H:%M:%SZ')" || timestamp="unknown"
  mkdir -p "$LOG_DIR" 2>/dev/null || return 0
  printf '%s [%s] %s\n' "$timestamp" "$LOG_TAG" "$msg" >> "$LOG_FILE" 2>/dev/null || true
}

log "driver v1.0.0-alpha1"

## extract received data
xml_content=$(base64 -d)
log "received data from OpenNebula $xml_content"

## Identifying our server on scaleway using cloud init metadata endpoint
SERVER_ID="$(curl https://cloudinit.brm.par2.scaleway.com/v1/cloudinit/b0bd7196-5816-4781-b62b-bbe6b880e2d0/meta-data --silent | jq .external_id)"
log "working on server id $SERVER_ID"


[[ -n "$SERVER_ID" ]]  || {
  log "Failed to fetch server id $SERVER_ID ?"
  exit 0
}

[[ -r "$TOKEN_FILE" ]] || {
  log "Token file $TOKEN_FILE missing, skipping attachment"
  exit 0
}

log "checking token"
## checking token
TOKEN="$(tr -d '\r\n' < "$TOKEN_FILE")"
[[ -n "$TOKEN" ]] || {
  log "Token empty, skipping attachment"
  exit 0
}

log "fetch AR IP from OpenNebula input data"
## fetch AR IP from ON input data
FIP_IP="$(echo "$xml_content" | xpath -e "/VM/TEMPLATE/NIC/IP/text()")"

log "fetched AR IP $FIP_IP"

[[ -n "$FIP_IP" ]] || {
  log "could not get AR IP details"
  exit 0
}

log "fetch FIP ID from existing FIP"
## fetch FIP ID from existing FIP

fip_resp="$(curl -sf -X GET -H "X-Auth-Token: $TOKEN" -H "Content-Type: application/json" "$API_ENDPOINT/zones/$ZONE/fips")" 

log "response $fip_resp"

# filtering our IP
FIP_ID="$(echo "$fip_resp" | jq -r --arg ip "$FIP_IP" '.flexible_ips[] | select(.ip_address == $ip) | .id // empty')"
log "Found  FIP ID for $FIP_IP => $FIP_ID"

log "fetch flexible ips details" 
#fetch flexible ips details
info_json="$(curl -sf -H "X-Auth-Token: $TOKEN" "$API_ENDPOINT/zones/$ZONE/fips/$FIP_ID")" || {
  log "Failed to fetch Flexible IP $FIP_ID details"
  exit 1
}

log "FIP details $info_json"

log  "extracting FIP MAC"
MAC_ADDR="$(echo "$info_json" | jq -r '.flexible_ip.mac_address.mac_address // .mac_address.mac_address // empty')"

log "MAC_ADDR => $MAC_ADDR"
CURRENT_SERVER="$(echo "$info_json" | jq -r '.flexible_ip.server_id // .server_id // empty')"

log "Checking if fip is connected to our server yet => $CURRENT_SERVER" 

## add a mac adress if missing
if [[ -z "$MAC_ADDR" || "$MAC_ADDR" == "null" ]]; then
  mac_resp="$(curl -sf -X POST \
      -H "X-Auth-Token: $TOKEN" \
      -H "Content-Type: application/json" \
      -d '{"mac_type":"{{ one_driver_mac_type }}"}' \
      "$API_ENDPOINT/zones/$ZONE/fips/$FIP_ID/mac")" || {
    log "Failed to generate MAC for $FIP_ID"
    exit 1
    }
  MAC_ADDR="$(echo "$mac_resp" | jq -r '.mac_address.mac_address // empty')"
fi


log "--- FIP Attachment Logic ---"
log "Target FIP: $FIP_ID"
log "Target Server: $SERVER_ID"
log "Currently Attached Server: $CURRENT_SERVER"

if [[ "$CURRENT_SERVER" == "$SERVER_ID" ]]; then
  log "INFO: Flexible IP $FIP_ID is already attached to this server ($SERVER_ID). No action needed."

else
if [[ -n "$CURRENT_SERVER" ]]; then
    log "WARNING: FIP $FIP_ID is attached to a different server ($CURRENT_SERVER). Detaching first..."
    
    # !! ATTENTION !! Vérifiez cet endpoint /detach dans la documentation de l'API
    detach_endpoint="$API_ENDPOINT/zones/$ZONE/fips/detach"
    
    # Payload pour le détachement
    detach_payload=$(cat <<JSON
{
  "fips_ids": ["$FIP_ID"]
}
JSON
)

# Appel API de détachement
    if ! curl -sf -X POST \
        -H "X-Auth-Token: $TOKEN" \
        -H "Content-Type: application/json" \
        -d "$detach_payload" \
        "$detach_endpoint" >/dev/null; then
      log "ERROR: Detachment failed for FIP $FIP_ID from server $CURRENT_SERVER."
      exit 1 # Erreur critique
    else
      log "SUCCESS: FIP $FIP_ID detached from $CURRENT_SERVER."
    fi
  else
    log "INFO: FIP $FIP_ID is free and ready for attachment."
  fi

  # Étape 2: Attacher la FIP à notre serveur
  log "ACTION: Attaching FIP $FIP_ID to server $SERVER_ID..."
  
  # Payload pour l'attachement
  attach_payload=$(cat <<JSON
{
  "fips_ids": ["$FIP_ID"],
  "server_id": "$SERVER_ID"
}
JSON
)
if ! curl -sf -X POST \
      -H "X-Auth-Token: $TOKEN" \
      -H "Content-Type: application/json" \
      -d "$attach_payload" \
      "$API_ENDPOINT/zones/$ZONE/fips/attach" >/dev/null; then
    log "ERROR: Attachment failed for FIP $FIP_ID to server $SERVER_ID."
    exit 1 # Erreur critique
  else
    log "SUCCESS: FIP $FIP_ID attached to $SERVER_ID."
  fi

fi

log "--- FIP Attachment Logic Complete ---"
exit 0
