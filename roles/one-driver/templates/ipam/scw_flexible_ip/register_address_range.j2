#!/usr/bin/env python3
# Purpose: Normalize and emit an OpenNebula AR definition tailored for Scaleway Flexible IP usage.
# Expected input: Base64-encoded OpenNebula XML on stdin containing an AR element to register.
# Expected output: Prints a formatted AR block describing the address range parameters.
import sys
from common import (
    read_stdin_xml,
    parse_ar,
    format_ar_output,
    DEFAULT_MASK,
    DEFAULT_GATEWAY,
    DEFAULT_DNS,
)


def main():
    root = read_stdin_xml()
    if root is None:
        print("-1")
        return 1

    ar_element = root.find("./AR")
    if ar_element is None:
        print("-1")
        return 1

    ar = parse_ar(ar_element)
    if not ar.get("type"):
        ar["type"] = "IP4"
    if not ar.get("ip"):
        ar["ip"] = ar.get("network_address")
    if not ar.get("network_address"):
        ar["network_address"] = ar.get("ip")
    if not ar.get("size"):
        ar["size"] = "1"
    if not ar.get("network_mask"):
        ar["network_mask"] = DEFAULT_MASK
    if not ar.get("gateway") and DEFAULT_GATEWAY:
        ar["gateway"] = DEFAULT_GATEWAY

    dns_values = []
    dns_raw = ar.get("dns")
    if dns_raw:
        dns_values = [item for item in dns_raw.split() if item]
    elif DEFAULT_DNS:
        dns_values = [item for item in DEFAULT_DNS if item]
    ar["dns_values"] = dns_values

    print(format_ar_output(ar))
    return 0


if __name__ == "__main__":
    sys.exit(main())
