#!/usr/bin/env python3
# Purpose: Release a previously allocated Scaleway Flexible IP and remove its reservation state.
# Expected input: Base64-encoded OpenNebula XML on stdin containing an ADDRESS element with the IP to free.
# Expected output: Emits no data on success; logs release events to /var/log/ipam/scw_flexible_ip.log.
import sys
from common import (
    read_stdin_xml,
    parse_address,
    read_token,
    StateManager,
    detach_fip,
    delete_fip,
    log,
)


def main():
    token = read_token()

    root = read_stdin_xml()
    if root is None:
        return 0

    addr_element = root.find("./ADDRESS")
    if addr_element is None:
        return 0

    address = parse_address(addr_element)
    ip = address.get("ip")
    if not ip:
        return 0

    with StateManager() as state:
        entry = state.lookup_by_ip(ip)
        if not entry:
            return 0

        flex_id = entry.get("flexible_ip_id")
        state.release(ip)

    if token and flex_id:
        detach_fip(token, flex_id)
        delete_fip(token, flex_id)
        log(f"Released Flexible IP {flex_id} for {ip}")

    return 0


if __name__ == "__main__":
    sys.exit(main())
