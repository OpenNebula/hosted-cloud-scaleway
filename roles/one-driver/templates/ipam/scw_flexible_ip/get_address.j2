#!/usr/bin/env python3
# Purpose: Provision a single Scaleway Flexible IP on demand for OpenNebula virtual machines.
# Expected input: Base64-encoded OpenNebula XML on stdin containing AR and ADDRESS requests plus environment token.
# Expected output: Prints ADDRESS template populated with IP/MAC on success or "-1" on failure; logs actions to /var/log/ipam/scw_flexible_ip.log.
import sys
from common import (
    read_stdin_xml,
    parse_ar,
    parse_address,
    StateManager,
    create_flexible_ip,
    generate_mac,
    read_token,
    log,
    PROJECT_ID,
)
import time


def main():
    token = read_token()
    if not token:
        log("No Scaleway token available for get_address")
        print("-1")
        return 1

    root = read_stdin_xml()
    if root is None:
        print("-1")
        return 1

    ar_element = root.find("./AR")
    addr_element = root.find("./ADDRESS")
    if ar_element is None or addr_element is None:
        print("-1")
        return 1

    ar = parse_ar(ar_element)
    request = parse_address(addr_element)
    size = request.get("size") or "1"
    try:
        size_int = int(size)
    except ValueError:
        size_int = 1
    if size_int != 1:
        log(f"Unsupported allocation size {size_int}")
        print("-1")
        return 1

    if not PROJECT_ID:
        log("Project ID not configured; cannot create Flexible IP")
        print("-1")
        return 1

    with StateManager() as state:
        created = create_flexible_ip(
            token,
            PROJECT_ID,
            description=f"opennebula-reservation-{int(time.time())}"
        )
        flex_id = created.get("id") if created else None
        lease_ip = created.get("ip") if created else None
        mac = created.get("mac") if created else ""

        if not flex_id or not lease_ip:
            log("Failed to create a new Flexible IP")
            print("-1")
            return 1

        if not mac:
            mac = generate_mac(token, flex_id)
            if not mac:
                log(f"Failed to generate MAC for FIP {flex_id}")
                print("-1")
                return 1

        state.reserve(lease_ip, flex_id, mac)

    print(f'ADDRESS = [ IP = "{lease_ip}", SIZE = {size_int}, MAC = "{mac}", FLEXIBLE_IP_ID = "{flex_id}" ]')
    return 0


if __name__ == "__main__":
    sys.exit(main())
