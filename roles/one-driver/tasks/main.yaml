---
- name: "Ensure Scaleway driver dependencies are present"
  ansible.builtin.package:
    name: "{{ one_driver_dependencies }}"
    state: present
  become: true

- name: "Ensure API token for Flexible IP driver is provided"
  ansible.builtin.assert:
    that:
      - (one_driver_flexible_ip_token | length) > 0
    fail_msg: >
      one_driver_flexible_ip_token is empty. Provide the Scaleway
          API key (e.g. via scw_flexible_ip_token inventory variable).

- name: "Ensure Scaleway project ID is provided"
  ansible.builtin.assert:
    that:
      - (one_driver_project_id | length) > 0
    fail_msg: >
      one_driver_project_id is empty. Provide the Scaleway project UUID
      (e.g. via scw_project_id inventory variable).

- name: "Check OpenNebula configuration file"
  ansible.builtin.stat:
    path: /etc/one/oned.conf
  register: _scw_oned_conf
  become: true

- name: "Ensure directory for Scaleway token exists"
  ansible.builtin.file:
    path: "{{ one_driver_token_path | dirname }}"
    owner: oneadmin
    group: oneadmin
    mode: "0750"
    state: directory
  become: true

- name: "Ensure logging directories VNM exist"
  ansible.builtin.file:
    path: "{{ item }}"
    owner: oneadmin
    group: oneadmin
    mode: "0750"
    state: directory
  loop:
    - /var/log/vnm
  become: true

- name: "Write Scaleway API token for driver"
  ansible.builtin.copy:
    content: "{{ one_driver_flexible_ip_token }}"
    dest: "{{ one_driver_token_path }}"
    owner: oneadmin
    group: oneadmin
    mode: "0600"
  become: true

- name: "Write Scaleway API Server ID for driver"
  ansible.builtin.copy:
    content: "{{ scw_server_id }}"
    dest: "{{ one_driver_server_id_path }}"
    owner: oneadmin
    group: oneadmin
    mode: "0600"
  become: true

- name: "Ensure Scaleway bridge hook directories exist"
  ansible.builtin.file:
    path: "{{ item }}"
    owner: oneadmin
    group: oneadmin
    mode: "0755"
    state: directory
  loop:
    - "{{ one_driver_vnm_bridge_dir }}/pre.d"
    - "{{ one_driver_vnm_bridge_dir }}/clean.d"
  become: true

- name: "Install Scaleway bridge pre hook"
  ansible.builtin.template:
    src: vnm/bridge/pre.d/01-attach-flexip.sh.j2
    dest: "{{ one_driver_vnm_bridge_dir }}/pre.d/01-attach-flexip.sh"
    owner: oneadmin
    group: oneadmin
    mode: "0550"
  become: true

- name: "Install Scaleway bridge clean hook"
  ansible.builtin.template:
    src: vnm/bridge/clean.d/01-detach-flexip.sh.j2
    dest: "{{ one_driver_vnm_bridge_dir }}/clean.d/01-detach-flexip.sh"
    owner: oneadmin
    group: oneadmin
    mode: "0550"
  become: true

- name: "Read oned.conf"
  ansible.builtin.slurp:
    path: "{{ one_driver_oned_conf_path }}"
  register: _scw_oned_conf_content
  when: _scw_oned_conf.stat.exists and false
  become: true

- name: "Gather OpenNebula host IDs"
  ansible.builtin.command:
    cmd: onehost list -l ID --csv --no-header
  become: true
  become_user: oneadmin
  register: _scw_host_ids
  changed_when: false
  when: _scw_oned_conf.stat.exists

- name: "Show discovered host IDs"
  ansible.builtin.debug:
    msg: "Found OpenNebula hosts with IDs: {{ _scw_host_ids.stdout_lines | default([]) }}"
  when:
    - _scw_oned_conf.stat.exists
    - _scw_host_ids.stdout_lines != []

- name: "Synchronize OpenNebula hosts"
  ansible.builtin.command:
    cmd: onehost sync --force {{ item }}
  become: true
  become_user: oneadmin
  loop: "{{ _scw_host_ids.stdout_lines }}"
  register: _scw_onehost_sync
  changed_when: false
  failed_when: false
  when:
    - _scw_oned_conf.stat.exists
    - _scw_host_ids.stdout_lines != []

- name: "Display synchronization results"
  ansible.builtin.debug:
    msg: |
      Host ID: {{ item.item }}
      Synchronization output:
      {{ item.stdout | default('') }}
  loop: "{{ (_scw_onehost_sync.results if _scw_onehost_sync is defined else []) }}"
  when:
    - _scw_oned_conf.stat.exists
    - _scw_onehost_sync is defined

- name: "Warn about synchronization failures"
  ansible.builtin.debug:
    msg: |
      onehost sync failed for host ID {{ item.item }} ({{ item.rc }}):
      {{ item.stderr | default('') }}
  loop: "{{ (_scw_onehost_sync.results if _scw_onehost_sync is defined else []) }}"
  when:
    - _scw_oned_conf.stat.exists
    - _scw_onehost_sync is defined
    - (item.rc | default(0)) | int != 0
